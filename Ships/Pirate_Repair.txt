@clearjournal
while not dead
  headmsg "[REPAIR]" 92
  @canceltarget
  //
  // tracking warning
  //
  if @injournal 'now tracking' 'system'
    for 3
      headmsg "TRACKING PLAYER" 23
      pause 500
    endfor
    @clearjournal
  endif
  //
  // low bandages check
  //
  if counttype '0xe21' 'any' 'backpack' == 0
    headmsg "Out of bandages!" 38
    stop
  endif
  //
  // out of bandages check
  //
  if counttype '0xe21' 'any' 'backpack' < 20
    headmsg "Low on bandages" 38
    pause 1000
  endif
  //
  // get nearest friend for heal
  //
  if not @findalias 'hurtcrew' 
    for 20
      @Getfriend 'innocent' 'humanoid'
      if @inrange 'friend' 2
        @setalias 'hurtcrew' 'friend'
        pause 100
        break
      endif
    endfor
  endif
  //
  // wait for bandage finish
  //
  if @timerexists 'healing'
    if timer 'healing' > 15000
      @removetimer 'healing'
    endif
    if @injournal 'heal' 'system'
      @removetimer 'healing'
    endif
    if @injournal 'cure' 'system'
      @removetimer 'healing'
    endif
    if @injournal 'finish' 'system'
      @removetimer 'healing'
    endif
  endif
  //
  // Check self heal
  //
  if not timerexists 'healing'
    if poisoned 'self' or diffhits > 10
      createtimer 'healing'
      headmsg "(bandaging)" 67
      bandageself
      @clearjournal
    endif
  endif
  //
  // Does crew need a bandage?
  //
  if not @timerexists 'healing'
    headmsg "no timer"
    if findalias 'hurtcrew'
      headmsg "found hurtcrew"
      if @inrange 'hurtcrew' 2
        headmsg "in range 2"
        @clearjournal
        usetype 0xe21 'any' 'backpack'
        waitfortarget 5000
        target! 'hurtcrew'
        pause 500
        //
        // if crewman doesn't need a bandage, unset it
        //
        if @injournal 'not damaged' 'system'
          @unsetalias 'hurtcrew'
          headmsg "wasnt hurt, unsetting"
        else
          headmsg "(bandaging crew)" 67
          createtimer 'healing'
        endif
      else
        headmsg "hurtcrew out of range"
        @unsetalias 'hurtcrew'
      endif
    else
      headmsg "no hurtcrew"
    endif
  endif
  //
  // Repair ship
  //
  @usetype 0x649e 'any' 'backpack'
  waitforgump 0x4bcb6173 2000
  @replygump 0x4bcb6173 2
  waitforgump 0x4bcb6173 2000
  @replygump 0x4bcb6173 3
  waitforgump 0x4bcb6173 2000
  @replygump 0x4bcb6173 4
  pause 1000
endwhile
