/////////////////////////////////////////////
// UO Steam Get Closest Enemy Macro (for PVM)
// for Outlands
//
// Greetings and thank you for your interest in this script!
// This macro is *primarily* for PVM, and is a "general purpose"
// script for most players on the shard doing PVM. Its primary
// purpose is to scan around you for the closest target, sets
// that target to your 'enemy' alias, attacks that target, and
// targets same (to set last target or drop spell).
//
// Please please PLEASE read all my notes
// on on how this script works. It will help you understand
// why I made certain choices.
//
// How to use:
// ===========
// 1. Enable [X] Highlight Current Target in UOSteam
// 2. Record a dress profile named 'default' with your 
//    weapon equipped (or spellbook, etc).
// 3. Run macro any time to locate nearest target and attack.
//
// What makes it PVM?
// 
//    If you look at the filter below, it does not have a "humanoid"
//    entry. Thus you will pick up any type of mob/player closest to you,
//    matching the existing filter.
//
//    You can still use it for PVP, but it will pick up red pets for example,
//    and not prioritize the red player. 
//
// Friends list
// 
//    Add anything you do not want to target to your friends list. This includes
//    guild PKs, their pets, guildies who flag grey, etc. Once on that list,
//    the macro will no longer pick them up.
//
// Why not 'transformation'?
//
//    A lot of people confuse the 'transformation' filter with Polymorph. Its
//    100% different. Transformation is for gargoyle, elf, vampire body types.
//    This shard does not use those.
//
// Why is it attacking my target?
//
//    When [X] Highlight Current Target is enabled, your current target will be
//    highlighted (we know this). What you don't know - is that when you switch
//    your 'enemy' alias, there is no way to "swap" the highlighted target from
//    the old one to the new one without attacking it! I looked and looked - there
//    is literally no way to do it, aside from actually attacking it.
//
//    To prevent one target from being highlighted, and another being set to
//    your 'enemy' (and not highlighted), which is very confusing, the new 
//    'enemy' serial has to be attacked at least once. This will switch your
//    target highlight as expected.
//
// Active target prompts
//
//    An active target reticle will not be affected by this script
//
// Questions?
//
//    If you have questions on why its written this way, or what I am doing,
//    just PM me in discord. I could write articles on the UO targetting system,
//    but I won't do that here.
//
// How to use:
// ===========
// 1) Make sure you have '[X] Highlight Current Target' enabled in UOSteam
// 2) Run script any time to get closest enemy.
//
// Version History:
// ----------------
// * 1.0 complete rewrite
//
// >> COPY BELOW >> 
/////////////////////////////////////////////

//
// Create temporary list
// 
@removelist 'enemies'
@createlist 'enemies'

//
// Scan for targets
//
for 0 to 20
    @getenemy 'murderer' 'enemy' 'criminal' 'gray' 'next'
    @pushlist! 'enemies' 'enemy'
endfor

for 0 to 'enemies'
    sysmsg enemies[]
endfor

//
// Create a distances list, seeding from 1
// 
@removelist 'distances'
@createlist 'distances'
pushlist 'distances' 1
pushlist 'distances' 2
pushlist 'distances' 3
pushlist 'distances' 4
pushlist 'distances' 5
pushlist 'distances' 6
pushlist 'distances' 7
pushlist 'distances' 8
pushlist 'distances' 9
pushlist 'distances' 10
pushlist 'distances' 11
pushlist 'distances' 12
pushlist 'distances' 13
pushlist 'distances' 14
pushlist 'distances' 15
pushlist 'distances' 16
pushlist 'distances' 17
pushlist 'distances' 18
pushlist 'distances' 19
pushlist 'distances' 20

//
// Sort by distance
//  
@unsetalias 'enemy'
if not @findobject 'enemy'
  sysmsg "enemy is unset"
endif
for 0 to 'distances'
    sysmsg distances[]
    if not findobject 'enemy'
        sysmsg "enemy is unset"
    else
        sysmsg "enemy is set"
    endif
    if not @findobject 'enemy'
        for 0 to 'enemies'
            if @inrange enemies[] distances[] and not dead enemies[]
                sysmsg enemies[]
                setalias 'enemy' enemies[]
                @removelist 'found'
                @createlist 'found'
                if findobject 'enemy'
                  sysmsg "enemy found pushing list"
                  @pushlist! 'found' 'enemy'
                else
                  sysmsg "enemy not found"
                  sysmsg "no enemy"
                endif
                sysmsg "printing enemies"
                for 0 to 'found'
                  sysmsg found[]
                endfor
                break
            endif
        endfor
    else
        break
    endif
endfor

//
// Player feedback
//
if @findobject 'last'
    headmsg "*Target Set*" 22
else
    headmsg "No targets" 44
endif


@removelist 'found'
@createlist 'found'
if findobject 'enemy'
sysmsg "enemy found pushing list"
@pushlist! 'found' 'enemy'
else
sysmsg "enemy not found"
sysmsg "no enemy"
endif
sysmsg "printing enemies"
for 0 to 'found'
sysmsg found[]
endfor
target 'enemy'
attack! 'enemy'